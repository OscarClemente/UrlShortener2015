-- Clean database

DROP TABLE MULTIPLESURIS IF EXISTS;
DROP TABLE CLICK IF EXISTS;
DROP TABLE SHORTURL IF EXISTS;
DROP TABLE USERS IF EXISTS;
DROP TABLE AUTHORITIES IF EXISTS;
DROP TABLE USERCONNECTION IF EXISTS;
DROP TABLE USERPROFILE IF EXISTS;

-- ShortURL

CREATE TABLE SHORTURL(
	HASH		VARCHAR(30),				-- Key
	TARGET		VARCHAR(1024),				-- Original URL
	SPONSOR		VARCHAR(1024),				-- Sponsor URL
	CREATED 	TIMESTAMP,					-- Creation date
	OWNER		VARCHAR(255),				-- User id
	MODE		INTEGER,					-- Redirect mode
	SAFE		BOOLEAN,					-- Safe target
	IP			VARCHAR(20),				-- IP
	COUNTRY		VARCHAR(50),				-- Country
	USERNAME	VARCHAR(45),				-- Username
	PRIMARY KEY (HASH, USERNAME)
);

-- Click

CREATE TABLE CLICK(
    ID 			BIGINT IDENTITY PRIMARY KEY, -- Key
	HASH 		VARCHAR(10) NOT NULL,		-- Foreing key	
	CREATED 	TIMESTAMP,					-- Creation date
	REFERRER	VARCHAR(1024),				-- Traffic origin
	BROWSER		VARCHAR(50),				-- Browser
	PLATFORM	VARCHAR(50),				-- Platform
	IP			VARCHAR(20),				-- IP
	COUNTRY		VARCHAR(50),				-- Country
	USERNAME	VARCHAR(45),				-- Username
	CONSTRAINT FK_CLICK FOREIGN KEY(HASH, USERNAME) REFERENCES SHORTURL(HASH, USERNAME)
);

-- Usuario

CREATE TABLE USERS(
	USERNAME	VARCHAR(45) NOT NULL PRIMARY KEY,	-- Key
	NICK		VARCHAR(45) NOT NULL,				-- Nick
	PASSWORD	VARCHAR(45) NOT NULL,				-- Contraseña
	ENABLED		BOOLEAN NOT NULL
);

CREATE TABLE AUTHORITIES(
    USERNAME	VARCHAR(45) NOT NULL,				-- Key
    AUTHORITY	VARCHAR(45) NOT NULL,				-- Autoridad
    CONSTRAINT FK_AUTHORITIES_USERS FOREIGN KEY(USERNAME) REFERENCES USERS(USERNAME)
);

CREATE UNIQUE INDEX IX_AUTH_USERNAME ON AUTHORITIES(USERNAME, AUTHORITY);

-- MultiplesURIs

CREATE TABLE MULTIPLESURIS(
	HASH			VARCHAR(30),						-- Key, id original
	USERNAME		VARCHAR(45),						-- Key, Username
	TARGET			VARCHAR(1024) NOT NULL PRIMARY KEY,			-- Key, destino
	EXPRESSION		VARCHAR(1024),						-- Regular expression
	CONSTRAINT FK_MULTIPLES_URIS FOREIGN KEY(HASH, USERNAME) REFERENCES SHORTURL(HASH, USERNAME)
);

CREATE TABLE USERCONNECTION(
	USERID			VARCHAR(255) NOT NULL,
	PROVIDERID		VARCHAR(255) NOT NULL,
	PROVIDERUSERID	VARCHAR(255),
	RANK			INT NOT NULL,
	DISPLAYNAME		VARCHAR(255),
	PROFILEURL		VARCHAR(512),
	IMAGEURL		VARCHAR(512),
	ACCESSTOKEN		VARCHAR(1024) NOT NULL,
	SECRET			VARCHAR(255),
	REFRESHTOKEN	VARCHAR(255),
	EXPIRETIME		BIGINT,
	PRIMARY KEY (USERID, PROVIDERID, PROVIDERUSERID)
);

CREATE UNIQUE INDEX USERCONNECTIONRANK ON USERCONNECTION(USERID, PROVIDERID, RANK);

CREATE TABLE USERPROFILE(
	USERID			VARCHAR(255) NOT NULL,
	EMAIL			VARCHAR(255),
	FIRSTNAME		VARCHAR(255),
	LASTNAME		VARCHAR(255),
	NAME			VARCHAR(255),
	USERNAME		VARCHAR(255),
	PRIMARY KEY (USERID)
);

CREATE UNIQUE INDEX USERPROFILEPK ON USERPROFILE(USERID);